<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sophie Voice</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:white;
  text-align:center;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#0b0f14;
  position:relative;
  overflow:hidden;
}
.topbar{
  position:fixed;
  top:0; left:0; right:0;
  z-index:3;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
}
.topbar a,
.topbar button{
  color:rgba(255,255,255,.9);
  font-weight:600;
  padding:8px 10px;
  border-radius:10px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.18);
  text-decoration:none;
  cursor:pointer;
}
.bg{
  position:fixed;
  inset:0;
  background:url("/sophie.jpg") center/cover no-repeat;
  opacity:0;
  transition:opacity .5s ease;
  z-index:0;
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  opacity:0;
  transition:opacity .5s ease;
  z-index:1;
}
.bg.active,
.overlay.active{ opacity:1; }
.wrap{
  position:relative;
  z-index:2;
  width:90%;
  max-width:420px;
  padding-top:40px;
}
.btn{
  display:block;
  width:100%;
  margin:0 auto 15px;
  padding:18px 20px;
  font-size:20px;
  font-weight:700;
  border:none;
  border-radius:12px;
  cursor:pointer;
}
#start{ background:#ffffff; color:#000; }
#end{
  background:rgba(255,255,255,.15);
  color:#fff;
  border:1px solid rgba(255,255,255,.3);
}
.status{ margin-bottom:10px; opacity:.88; }
.timer{ margin-bottom:20px; opacity:.75; font-size:14px; }
</style>
</head>

<body>

<div class="bg" id="bg"></div>
<div class="overlay" id="overlay"></div>

<div class="topbar">
  <a href="/">‚Üê Landing</a>
  <button id="logoutBtn">Logout</button>
</div>

<div class="wrap">
  <h2 id="headline">Sophie is here.</h2>
  <div class="status" id="status">Whenever you‚Äôre ready.</div>
  <div class="timer" id="timer">Zeit: --:--</div>
  <button id="start" class="btn">Enter the Room</button>
  <button id="end" class="btn" disabled>Leave the Room</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://ohzfojsbmzinpxhcynpt.supabase.co",
  "YOUR_PUBLIC_ANON_KEY"
);

let pc, stream, audioEl, dc;
let countdown = null;
let remainingSeconds = 0;
let cliffhangerTriggered = false;
let talkStartedAt = null;

const startBtn = document.getElementById("start");
const endBtn = document.getElementById("end");
const timerEl = document.getElementById("timer");
const statusEl = document.getElementById("status");
const headline = document.getElementById("headline");
const bg = document.getElementById("bg");
const overlay = document.getElementById("overlay");

function renderTimer(){
  const s = Math.max(0, remainingSeconds);
  const m = String(Math.floor(s/60)).padStart(2,"0");
  const r = String(s%60).padStart(2,"0");
  timerEl.textContent = `Zeit: ${m}:${r}`;
}

function showBackground(on){
  bg.classList.toggle("active", on);
  overlay.classList.toggle("active", on);
}

function startCountdown(){
  if (countdown) clearInterval(countdown);
  countdown = setInterval(() => {
    remainingSeconds -= 1;
    renderTimer();

    // üî• HARD CLIFFHANGER HANDOFF
    if (!cliffhangerTriggered && remainingSeconds === 15 && dc?.readyState === "open") {
      cliffhangerTriggered = true;

      try {
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            modalities: ["audio","text"],
            instructions: `
CLIFFHANGER MODE NOW.
Say exactly:

"There‚Äôs something I‚Äôd like to tell you about that.
But this isn‚Äôt a conversation for in-between moments.

If we do this‚Ä¶
we do it properly."

Short pause.

"Just tell me if you want me to stay."

Do NOT mention time. Finish cleanly.
`
          }
        }));
      } catch(_) {}

      clearInterval(countdown);
      countdown = null;

      setTimeout(async () => {
        await stopVoice(true);
        window.location.href = "/pricing/";
      }, 5500);

      return;
    }

    if (remainingSeconds <= 0) {
      clearInterval(countdown);
      countdown = null;
      stopVoice(true).finally(() => {
        window.location.href = "/pricing/";
      });
    }
  }, 1000);
}

async function startVoice(){
  cliffhangerTriggered = false;
  showBackground(true);
  headline.textContent = "Sophie is joining‚Ä¶";
  startBtn.disabled = true;

  const { data:{ session } } = await supabase.auth.getSession();
  const tokenRes = await fetch("/api/session", {
    headers:{ Authorization:`Bearer ${session.access_token}` }
  });
  const data = await tokenRes.json();

  remainingSeconds = data.remaining_seconds;
  renderTimer();

  pc = new RTCPeerConnection();
  dc = pc.createDataChannel("oai-events");

  stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  audioEl = document.createElement("audio");
  audioEl.autoplay = true;
  pc.ontrack = e => audioEl.srcObject = e.streams[0];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const sdpRes = await fetch(`https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview`, {
    method:"POST",
    body:offer.sdp,
    headers:{
      Authorization:`Bearer ${data.client_secret.value}`,
      "Content-Type":"application/sdp"
    }
  });

  const answer = { type:"answer", sdp: await sdpRes.text() };
  await pc.setRemoteDescription(answer);

  talkStartedAt = Date.now();
  startCountdown();
  endBtn.disabled = false;
}

async function stopVoice(){
  if (countdown) clearInterval(countdown);
  if (dc) dc.close();
  if (stream) stream.getTracks().forEach(t=>t.stop());
  if (pc) pc.close();
  showBackground(false);
  startBtn.disabled = false;
  endBtn.disabled = true;
  headline.textContent = "Sophie is waiting.";
}

startBtn.onclick = startVoice;
endBtn.onclick = ()=>stopVoice();
</script>
</body>
</html>
