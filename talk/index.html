<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sophie Voice</title>

<style>
*{box-sizing:border-box}
body{
margin:0;
background:#0b0f14;
color:white;
font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
text-align:center;
padding:24px 16px 40px;
}
.wrap{width:min(560px,100%);margin:0 auto;}
h2{margin:18px 0 10px;font-weight:650;letter-spacing:.2px;}
.status{font-size:14px;opacity:.85;margin-bottom:14px;min-height:20px;}

.sophie-container{
width:100%;
margin:14px auto 22px;
opacity:0;
transform:translateY(6px) scale(.98);
transition:opacity .35s ease, transform .35s ease;
pointer-events:none;
}
.sophie-container.active{
opacity:1;
transform:translateY(0) scale(1);
}
.sophie-img{
width:100%;
border-radius:18px;
box-shadow:0 20px 55px rgba(0,0,0,.55);
display:block;
}

.btn{
display:block;
width:100%;
max-width:520px;
margin:0 auto 12px;
border:0;
border-radius:16px;
padding:18px 20px;
font-size:18px;
font-weight:750;
cursor:pointer;
transition:transform .12s ease, opacity .12s ease;
}
#start{
background:#ffffff;
color:#000;
box-shadow:0 18px 40px rgba(0,0,0,.45);
}
#end{
background:rgba(255,255,255,.12);
color:#fff;
border:1px solid rgba(255,255,255,.22);
}
.btn:disabled{opacity:.55;cursor:not-allowed;}
@media (max-width:480px){
.btn{padding:22px;font-size:20px;border-radius:18px;}
}
</style>
</head>

<body>
<div class="wrap">
  <h2 id="headline">Sophie wartet.</h2>
  <div class="status" id="status">Bereit.</div>

  <div class="sophie-container" id="sophieBox">
    <img src="/sophie.jpg" class="sophie-img" alt="Sophie" />
  </div>

  <button class="btn" id="start">Jetzt sprechen</button>
  <button class="btn" id="end" disabled>Gespräch beenden</button>
</div>

<script>
const startBtn  = document.getElementById("start");
const endBtn    = document.getElementById("end");
const statusEl  = document.getElementById("status");
const headline  = document.getElementById("headline");
const sophieBox = document.getElementById("sophieBox");

let pc = null;
let stream = null;
let audioEl = null;

function setStatus(t){ statusEl.textContent = t; }
function showImage(on){ sophieBox.classList.toggle("active", !!on); }

async function stopVoice(){
  endBtn.disabled = true;

  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  if(pc){
    try{ pc.ontrack = null; pc.close(); }catch(e){}
    pc = null;
  }
  if(audioEl){
    try{ audioEl.srcObject = null; }catch(e){}
    audioEl = null;
  }

  showImage(false);
  startBtn.disabled = false;
  headline.textContent = "Sophie wartet.";
  setStatus("Beendet.");
}

async function startVoice(){
  startBtn.disabled = true;
  headline.textContent = "Sophie verbindet sich…";
  setStatus("Mikro wird geöffnet…");

  try{
    // Mic first: mic on => image on (Telefongefühl)
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    showImage(true);
    setStatus("Verbinde…");

    const tokenRes = await fetch("/api/session");
    const data = await tokenRes.json();

    pc = new RTCPeerConnection();
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    pc.ontrack = e => { audioEl.srcObject = e.streams[0]; };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const baseUrl = "https://api.openai.com/v1/realtime";
    const model = "gpt-4o-realtime-preview";

    const sdpRes = await fetch(`${baseUrl}?model=${model}`, {
      method: "POST",
      body: offer.sdp,
      headers: {
        Authorization: `Bearer ${data.client_secret.value}`,
        "Content-Type": "application/sdp"
      },
    });

    if(!sdpRes.ok) throw new Error("Realtime SDP Fehler: " + sdpRes.status);

    const answer = { type: "answer", sdp: await sdpRes.text() };
    await pc.setRemoteDescription(answer);

    endBtn.disabled = false;
    headline.textContent = "Sophie hört zu.";
    setStatus("Live.");
  } catch(err){
    console.error(err);
    setStatus("Start fehlgeschlagen. Bitte erneut versuchen.");
    await stopVoice();
  }
}

startBtn.addEventListener("click", startVoice);
endBtn.addEventListener("click", stopVoice);
</script>
</body>
</html>
