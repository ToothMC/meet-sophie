<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sophie Voice</title>
</head>

<body style="background:#0b0f14;color:white;font-family:sans-serif;text-align:center;padding-top:100px;">

<h2 id="headline">Sophie wartet.</h2>
<div id="status" style="opacity:.8;margin-bottom:20px;">Bereit.</div>

<!-- NUR NEU: Bild (standardmäßig aus) -->
<div id="sophieBox" style="display:none;width:90%;max-width:420px;margin:20px auto;">
  <img src="/sophie.jpg" alt="Sophie"
       style="width:100%;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.6);display:block;">
</div>

<!-- Buttons: wie vorher, nur etwas größer -->
<button id="start"
  style="display:block;width:90%;max-width:420px;margin:0 auto 15px;
         padding:18px 20px;font-size:20px;font-weight:600;border:none;
         border-radius:10px;background:#fff;color:#000;cursor:pointer;">
  Jetzt sprechen
</button>

<button id="end" disabled
  style="display:block;width:90%;max-width:420px;margin:0 auto 15px;
         padding:16px 18px;font-size:18px;font-weight:600;
         border-radius:10px;background:rgba(255,255,255,.15);color:#fff;
         border:1px solid rgba(255,255,255,.3);cursor:pointer;">
  Gespräch beenden
</button>

<script>
const startBtn = document.getElementById("start");
const endBtn   = document.getElementById("end");
const statusEl = document.getElementById("status");
const headline = document.getElementById("headline");
const sophieBox = document.getElementById("sophieBox");

let pc = null;
let stream = null;
let audioEl = null;

function setStatus(txt){
  statusEl.textContent = txt;
}

startBtn.onclick = async () => {
  startBtn.disabled = true;
  headline.textContent = "Sophie verbindet sich…";
  setStatus("Verbinde…");

  // ✅ Bild EIN (sofort)
  sophieBox.style.display = "block";

  try {
    const tokenRes = await fetch("/api/session");
    const data = await tokenRes.json();

    pc = new RTCPeerConnection();
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    pc.ontrack = e => audioEl.srcObject = e.streams[0];

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const baseUrl = "https://api.openai.com/v1/realtime";
    const model = "gpt-4o-realtime-preview";

    const sdpRes = await fetch(`${baseUrl}?model=${model}`, {
      method: "POST",
      body: offer.sdp,
      headers: {
        Authorization: `Bearer ${data.client_secret.value}`,
        "Content-Type": "application/sdp"
      },
    });

    const answer = { type: "answer", sdp: await sdpRes.text() };
    await pc.setRemoteDescription(answer);

    endBtn.disabled = false;
    setStatus("Live.");
    headline.textContent = "Sophie hört zu.";
  } catch (err) {
    console.error(err);
    setStatus("Fehler beim Start.");
    headline.textContent = "Sophie wartet.";
    startBtn.disabled = false;
    stopVoice();
  }
};

function stopVoice(){
  endBtn.disabled = true;

  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }

  if(pc){
    try{ pc.close(); } catch(e){}
    pc = null;
  }

  if(audioEl){
    try{ audioEl.srcObject = null; } catch(e){}
    audioEl = null;
  }

  // ✅ Bild AUS
  sophieBox.style.display = "none";

  startBtn.disabled = false;
  headline.textContent = "Sophie wartet.";
  setStatus("Beendet.");
}

endBtn.onclick = stopVoice;
</script>

</body>
</html>
