<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sophie Voice</title>

<style>
*{box-sizing:border-box}

body{
margin:0;
font-family:sans-serif;
color:white;
text-align:center;
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
background:#0b0f14;
position:relative;
overflow:hidden;
}

/* Hintergrundbild */
.bg{
position:fixed;
inset:0;
background:url("/sophie.jpg") center/cover no-repeat;
opacity:0;
transition:opacity .5s ease;
z-index:0;
}

/* dunkles Overlay */
.overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.55);
opacity:0;
transition:opacity .5s ease;
z-index:1;
}

/* Aktiv-Zustand */
.bg.active,
.overlay.active{
opacity:1;
}

/* Vordergrund */
.wrap{
position:relative;
z-index:2;
width:90%;
max-width:420px;
}

/* Buttons */
.btn{
display:block;
width:100%;
margin:0 auto 15px;
padding:18px 20px;
font-size:20px;
font-weight:600;
border:none;
border-radius:12px;
cursor:pointer;
}

#start{
background:#ffffff;
color:#000;
}

#end{
background:rgba(255,255,255,.15);
color:#fff;
border:1px solid rgba(255,255,255,.3);
}

.btn:disabled{
opacity:.5;
cursor:not-allowed;
}

.status{
margin-bottom:20px;
opacity:.85;
}
</style>
</head>

<body>

<div class="bg" id="bg"></div>
<div class="overlay" id="overlay"></div>

<div class="wrap">
  <h2 id="headline">Sophie wartet.</h2>
  <div class="status" id="status">Bereit.</div>

  <button id="start" class="btn">Jetzt sprechen</button>
  <button id="end" class="btn" disabled>GesprÃ¤ch beenden</button>
</div>

<script>
const startBtn = document.getElementById("start");
const endBtn   = document.getElementById("end");
const statusEl = document.getElementById("status");
const headline = document.getElementById("headline");
const bg = document.getElementById("bg");
const overlay = document.getElementById("overlay");

let pc = null;
let stream = null;
let audioEl = null;

function setStatus(txt){
  statusEl.textContent = txt;
}

function showBackground(on){
  if(on){
    bg.classList.add("active");
    overlay.classList.add("active");
  } else {
    bg.classList.remove("active");
    overlay.classList.remove("active");
  }
}

async function startVoice(){
  startBtn.disabled = true;
  headline.textContent = "Sophie verbindet sichâ€¦";
  setStatus("Verbindeâ€¦");

  showBackground(true); // ðŸ”¥ Hintergrund einblenden

  try{
    const tokenRes = await fetch("/api/session");
    const data = await tokenRes.json();

    pc = new RTCPeerConnection();
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    pc.ontrack = e => audioEl.srcObject = e.streams[0];

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const baseUrl = "https://api.openai.com/v1/realtime";
    const model = "gpt-4o-realtime-preview";

    const sdpRes = await fetch(`${baseUrl}?model=${model}`, {
      method: "POST",
      body: offer.sdp,
      headers: {
        Authorization: `Bearer ${data.client_secret.value}`,
        "Content-Type": "application/sdp"
      },
    });

    const answer = { type: "answer", sdp: await sdpRes.text() };
    await pc.setRemoteDescription(answer);

    endBtn.disabled = false;
    setStatus("Live.");
    headline.textContent = "Sophie hÃ¶rt zu.";
  } catch(err){
    console.error(err);
    setStatus("Fehler beim Start.");
    headline.textContent = "Sophie wartet.";
    startBtn.disabled = false;
    stopVoice();
  }
}

function stopVoice(){
  endBtn.disabled = true;

  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }

  if(pc){
    try{ pc.close(); } catch(e){}
    pc = null;
  }

  if(audioEl){
    try{ audioEl.srcObject = null; } catch(e){}
    audioEl = null;
  }

  showBackground(false); // ðŸ”¥ Hintergrund ausblenden

  startBtn.disabled = false;
  headline.textContent = "Sophie wartet.";
  setStatus("Beendet.");
}

startBtn.addEventListener("click", startVoice);
endBtn.addEventListener("click", stopVoice);
</script>

</body>
</html>
