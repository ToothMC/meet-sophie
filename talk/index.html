<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sophie Voice</title>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:white;
  text-align:center;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#0b0f14;
  position:relative;
  overflow:hidden;
}

.topbar{
  position:fixed;
  top:0; left:0; right:0;
  z-index:3;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
}

.topbar a,
.topbar button{
  color:rgba(255,255,255,.9);
  font-weight:600;
  padding:8px 10px;
  border-radius:10px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.18);
  text-decoration:none;
  cursor:pointer;
}

.topbar button:disabled{
  opacity:.5;
  cursor:not-allowed;
}

.bg{
  position:fixed;
  inset:0;
  background:url("/sophie.jpg") center/cover no-repeat;
  opacity:0;
  transition:opacity .5s ease;
  z-index:0;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  opacity:0;
  transition:opacity .5s ease;
  z-index:1;
}

.bg.active,
.overlay.active{ opacity:1; }

.wrap{
  position:relative;
  z-index:2;
  width:90%;
  max-width:420px;
  padding-top:40px;
}

.btn{
  display:block;
  width:100%;
  margin:0 auto 15px;
  padding:18px 20px;
  font-size:20px;
  font-weight:700;
  border:none;
  border-radius:12px;
  cursor:pointer;
}

#start{ background:#ffffff; color:#000; }
#end{
  background:rgba(255,255,255,.15);
  color:#fff;
  border:1px solid rgba(255,255,255,.3);
}

.btn:disabled{ opacity:.5; cursor:not-allowed; }

.status{ margin-bottom:10px; opacity:.88; }
.timer{ margin-bottom:20px; opacity:.75; font-size:14px; }
</style>
</head>

<body>

<div class="bg" id="bg"></div>
<div class="overlay" id="overlay"></div>

<div class="topbar">
  <a href="/">← Landing</a>
  <button id="logoutBtn" type="button">Logout</button>
</div>

<div class="wrap">
  <h2 id="headline">Sophie is here.</h2>
  <div class="status" id="status">Whenever you’re ready.</div>
  <div class="timer" id="timer">Free-Time: --:--</div>

  <button id="start" class="btn">Enter the Room</button>
  <button id="end" class="btn" disabled>Leave the Room</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://ohzfojsbmzinpxhcynpt.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const { data: { session } } = await supabase.auth.getSession();
if (!session?.user) window.location.href = "/login/";

const startBtn = document.getElementById("start");
const endBtn   = document.getElementById("end");
const statusEl = document.getElementById("status");
const timerEl  = document.getElementById("timer");
const headline = document.getElementById("headline");
const bg = document.getElementById("bg");
const overlay = document.getElementById("overlay");
const logoutBtn = document.getElementById("logoutBtn");

let pc=null, stream=null, audioEl=null, dc=null;
let countdown=null, dynamicResetInterval=null;
let remainingSeconds=15*60, isPremium=false;
let talkStartedAt=null;

let convoLog=[], partialAssistant="", lastAssistantFinal="";
const userTranscriptBuffer=new Map();

let startSent=false;
let responseInProgress=false;
let lastResponseCreateAt=0;

function setStatus(t){ statusEl.textContent=t; }
function showBackground(on){
  bg.classList.toggle("active",on);
  overlay.classList.toggle("active",on);
}
function renderTimer(){
  if(isPremium){ timerEl.textContent="Premium: unlimited"; return; }
  const m=String(Math.floor(remainingSeconds/60)).padStart(2,"0");
  const s=String(remainingSeconds%60).padStart(2,"0");
  timerEl.textContent=`Free-Time: ${m}:${s}`;
}
renderTimer();

function canCreateResponse(){
  const now=Date.now();
  if(now-lastResponseCreateAt<900) return false;
  if(responseInProgress) return false;
  return true;
}

function sendResponseCreate(modalities=["audio","text"]){
  if(!dc||dc.readyState!=="open") return false;
  if(!canCreateResponse()) return false;
  responseInProgress=true;
  lastResponseCreateAt=Date.now();
  try{
    dc.send(JSON.stringify({type:"response.create",response:{modalities}}));
    return true;
  }catch(_){
    responseInProgress=false;
    return false;
  }
}

function maybeStartSophie(){
  if(startSent) return;
  if(!sendResponseCreate(["audio","text"])) return;
  startSent=true;
}

function triggerDynamicReset(){
  if(!dc||dc.readyState!=="open") return;
  if(responseInProgress) return;
  sendResponseCreate(["text"]);
}

function startDynamicResets(){
  stopDynamicResets();
  dynamicResetInterval=setInterval(triggerDynamicReset,120000);
}
function stopDynamicResets(){
  if(dynamicResetInterval){
    clearInterval(dynamicResetInterval);
    dynamicResetInterval=null;
  }
}

function attachChannel(ch){
  dc=ch;
  dc.addEventListener("open",()=>{
    try{
      dc.send(JSON.stringify({
        type:"session.update",
        session:{
          input_audio_transcription:{model:"gpt-4o-mini-transcribe"},
          turn_detection:{type:"server_vad"}
        }
      }));
    }catch(_){}
    maybeStartSophie();
  });

  dc.addEventListener("message",(ev)=>{
    try{
      const msg=JSON.parse(ev.data);

      if(msg?.type==="response.audio_transcript.delta"){
        partialAssistant+=String(msg?.delta||"");
        return;
      }

      if(msg?.type==="response.done"){
        responseInProgress=false;
        const final=String(partialAssistant||"").trim();
        if(final && final!==lastAssistantFinal){
          convoLog.push({role:"assistant",text:final});
          lastAssistantFinal=final;
        }
        partialAssistant="";
        return;
      }
    }catch(_){}
  });
}

async function startVoice(){
  startBtn.disabled=true;
  logoutBtn.disabled=true;
  showBackground(true);
  setStatus("connecting..");
  headline.textContent="Sophie is joining…";

  startSent=false;
  responseInProgress=false;
  lastResponseCreateAt=0;

  const {data:{session}}=await supabase.auth.getSession();
  const tokenRes=await fetch("/api/session",{headers:{Authorization:`Bearer ${session.access_token}`}});

  if(tokenRes.status===402){
    window.location.href="/pricing/";
    return;
  }

  const data=await tokenRes.json();
  isPremium=!!data?.is_premium;
  if(!isPremium && typeof data?.remaining_seconds==="number")
    remainingSeconds=data.remaining_seconds;

  renderTimer();

  pc=new RTCPeerConnection();
  pc.ondatachannel=(e)=>attachChannel(e.channel);
  attachChannel(pc.createDataChannel("oai-events"));

  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  audioEl=document.createElement("audio");
  audioEl.autoplay=true;
  pc.ontrack=e=>audioEl.srcObject=e.streams[0];

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  const sdpRes=await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",{
    method:"POST",
    body:offer.sdp,
    headers:{
      Authorization:`Bearer ${data.client_secret.value}`,
      "Content-Type":"application/sdp"
    }
  });

  const answer={type:"answer",sdp:await sdpRes.text()};
  await pc.setRemoteDescription(answer);

  setTimeout(()=>maybeStartSophie(),250);

  endBtn.disabled=false;
  setStatus("Live.");
  headline.textContent="Sophie is listening.";

  startDynamicResets();
}

async function stopVoice(){
  stopDynamicResets();
  if(dc) try{dc.close();}catch(e){}
  if(stream) stream.getTracks().forEach(t=>t.stop());
  if(pc) try{pc.close();}catch(e){}
  dc=null; stream=null; pc=null;
  showBackground(false);
  startBtn.disabled=false;
  logoutBtn.disabled=false;
  headline.textContent="Sophie is waiting.";
  setStatus("Ended.");
}

logoutBtn.onclick=async()=>{
  await stopVoice();
  await supabase.auth.signOut();
  window.location.href="/";
};

startBtn.onclick=startVoice;
endBtn.onclick=stopVoice;
</script>

</body>
</html>
