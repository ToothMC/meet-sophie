<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sophie – Talk</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:#0b0f14;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  text-align:center;
}
.container{
  max-width:500px;
  padding:20px;
}
button{
  margin-top:20px;
  padding:14px 22px;
  border-radius:12px;
  border:none;
  background:#ffffff;
  color:#000;
  font-weight:600;
  cursor:pointer;
}
#timer{
  margin-top:20px;
  opacity:.8;
}
</style>
</head>
<body>

<div class="container">
  <h1>Sophie</h1>
  <button id="startBtn">Start Talking</button>
  <div id="timer"></div>
</div>

<script>
let pc;
let dc;
let remainingSeconds = 0;
let countdownInterval;

const startBtn = document.getElementById("startBtn");
const timerEl = document.getElementById("timer");

startBtn.onclick = async () => {
  startBtn.disabled = true;

  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("Not logged in.");
    return;
  }

  const res = await fetch("/api/session", {
    headers: {
      Authorization: "Bearer " + token
    }
  });

  const session = await res.json();

  if (session.error) {
    alert(session.error);
    return;
  }

  remainingSeconds = session.remaining_seconds ?? 120;
  startCountdown();

  pc = new RTCPeerConnection();
  dc = pc.createDataChannel("oai-events");

  const audio = document.createElement("audio");
  audio.autoplay = true;

  pc.ontrack = e => audio.srcObject = e.streams[0];

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const baseUrl = "https://api.openai.com/v1/realtime";
  const model = "gpt-4o-realtime-preview";

  const answerRes = await fetch(`${baseUrl}?model=${model}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${session.client_secret.value}`,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  const answer = {
    type: "answer",
    sdp: await answerRes.text()
  };

  await pc.setRemoteDescription(answer);
};

function startCountdown() {
  updateTimerDisplay();

  countdownInterval = setInterval(() => {
    remainingSeconds -= 1;
    updateTimerDisplay();

    // ✅ 15s Cliffhanger Trigger
    if (remainingSeconds === 15 && dc && dc.readyState === "open") {
      try {
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            modalities: ["audio", "text"],
            instructions: `
CLIFFHANGER MODE NOW.

Say exactly:

"There’s something I’d like to tell you about that.
But this isn’t a conversation for in-between moments.

If we do this…
we do it properly."

Short pause.

"Just tell me if you want me to stay."

Do NOT mention time limits.
Do NOT explain anything.
Keep it intimate and calm.
`
          }
        }));
      } catch (e) {}
    }

    if (remainingSeconds <= 0) {
      clearInterval(countdownInterval);
      endSession();
    }

  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(remainingSeconds / 60);
  const seconds = remainingSeconds % 60;
  timerEl.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;
}

function endSession() {
  if (pc) pc.close();
  alert("Free time is over.");
  window.location.href = "/pricing";
}
</script>

</body>
</html>
