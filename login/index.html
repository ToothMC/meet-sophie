<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meet Sophie – Login</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 520px;
      margin: 60px auto;
      padding: 0 16px;
      background: #f9f9f9;
    }

    h2 { margin-bottom: 24px; }

    .box {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      padding: 20px;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
    }

    .primary { background: #111; color: white; }
    .secondary { background: #eee; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .ok { color: #0a7; }
    .err { color: #c00; }

    .muted {
      font-size: 14px;
      opacity: .7;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h2>Before you enter the room…</h2>

  <div class="box">
    <label>Email</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />

    <label>Passwort</label>
    <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />

    <div class="row">
      <button id="signup" class="secondary" type="button">Registrieren</button>
      <button id="signin" class="primary" type="button">Login</button>
    </div>

    <p id="status" class="muted"></p>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://ohzfojsbmzinpxhcynpt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oemZvanNibXppbnB4aGN5bnB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0Mzc1MjcsImV4cCI6MjA4NzAxMzUyN30.7eGSeEvOCj9vMqFJj9C0SR8DiiYygbFUvpQ8rIVEc0I";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");

    function setStatus(msg, ok = true) {
      statusEl.textContent = msg;
      statusEl.className = ok ? "ok muted" : "err muted";
      if (!ok) console.error(msg);
    }

    // -----------------------------------------
    // Wenn bereits eingeloggt → direkt zu /talk
    // -----------------------------------------
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      window.location.href = "/talk";
    }

    // -----------------------------------------
    // Hilfsfunktionen
    // -----------------------------------------

    async function ensureUserMemoryRow(userId) {
      const { data: existing, error: selErr } = await supabase
        .from("user_memory")
        .select("user_id")
        .eq("user_id", userId)
        .maybeSingle();

      if (selErr) throw new Error("DB Fehler (select user_memory): " + selErr.message);

      if (!existing) {
        const { error: insErr } = await supabase.from("user_memory").insert({
          user_id: userId,
          profile_notes: "",
          relationship_summary: ""
        });
        if (insErr) throw new Error("DB Fehler (insert user_memory): " + insErr.message);
      }
    }

    async function ensureUserUsageRow(userId) {
      const { data: existing, error: selErr } = await supabase
        .from("user_usage")
        .select("user_id")
        .eq("user_id", userId)
        .maybeSingle();

      if (selErr) throw new Error("DB Fehler (select user_usage): " + selErr.message);

      if (!existing) {
        const { error: insErr } = await supabase.from("user_usage").insert({
          user_id: userId,
          free_seconds_total: 900,
          free_seconds_used: 0
        });
        if (insErr) throw new Error("DB Fehler (insert user_usage): " + insErr.message);
      }
    }

    // ✅ NEU: user_relationship Row sicherstellen (damit /api/session immer Continuity lesen kann)
    async function ensureUserRelationshipRow(userId) {
      const { data: existing, error: selErr } = await supabase
        .from("user_relationship")
        .select("user_id")
        .eq("user_id", userId)
        .maybeSingle();

      if (selErr) throw new Error("DB Fehler (select user_relationship): " + selErr.message);

      if (!existing) {
        const { error: insErr } = await supabase.from("user_relationship").insert({
          user_id: userId,
          tone_baseline: "",
          openness_level: "",
          emotional_patterns: "",
          last_interaction_summary: "",
          updated_at: new Date().toISOString(),
        });
        if (insErr) throw new Error("DB Fehler (insert user_relationship): " + insErr.message);
      }
    }

    async function handleSuccessfulAuth() {
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr) return setStatus("Auth Fehler: " + userErr.message, false);
      if (!user) return;

      try {
        await ensureUserMemoryRow(user.id);
        await ensureUserUsageRow(user.id);
        await ensureUserRelationshipRow(user.id);
      } catch (e) {
        return setStatus(String(e?.message || e), false);
      }

      setStatus("Login erfolgreich. Weiterleitung…", true);
      window.location.href = "/talk";
    }

    // -----------------------------------------
    // Registrierung
    // -----------------------------------------
    $("signup").onclick = async () => {
      const email = $("email").value.trim();
      const password = $("password").value;

      if (!email || !password) {
        return setStatus("Email + Passwort eingeben.", false);
      }

      setStatus("Registriere…");

      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) return setStatus(error.message, false);

      // Wenn Email-Confirmation deaktiviert ist → sofort eingeloggt
      if (data.session) {
        await handleSuccessfulAuth();
      } else {
        setStatus("Bitte Email bestätigen.", true);
      }
    };

    // -----------------------------------------
    // Login
    // -----------------------------------------
    $("signin").onclick = async () => {
      const email = $("email").value.trim();
      const password = $("password").value;

      if (!email || !password) {
        return setStatus("Email + Passwort eingeben.", false);
      }

      setStatus("Logge ein…");

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return setStatus(error.message, false);

      await handleSuccessfulAuth();
    };
  </script>
</body>
</html>
