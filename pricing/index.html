<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sophie – Upgrade</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 18px; }
    button { width: 100%; padding: 14px; border: 0; border-radius: 12px; cursor: pointer; font-weight: 700; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { opacity: .7; }
    a { color: inherit; }
  </style>
</head>
<body>
  <h1>Sophie Premium</h1>
  <p class="muted">Deine Free-Zeit ist vorbei. Mit Premium geht’s sofort weiter.</p>

  <div class="card">
    <h2>Premium Abo</h2>
    <ul>
      <li>Unbegrenzte Gespräche</li>
      <li>Priorität beim Zugang</li>
      <li>Jederzeit kündbar</li>
    </ul>

    <button id="upgradeBtn">Jetzt upgraden</button>
    <p class="muted" id="msg"></p>
  </div>

  <p class="muted" style="margin-top:16px;">
    <a href="/login/">Zurück</a>
  </p>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://ohzfojsbmzinpxhcynpt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oemZvanNibXppbnB4aGN5bnB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0Mzc1MjcsImV4cCI6MjA4NzAxMzUyN30.7eGSeEvOCj9vMqFJj9C0SR8DiiYygbFUvpQ8rIVEc0I";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const msg = document.getElementById("msg");
    const btn = document.getElementById("upgradeBtn");

    async function track(event_name, meta = {}) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.access_token) return;

        await fetch("/api/track", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({ event_name, meta }),
        });
      } catch (_) {}
    }

    // Optional: Page view tracken
    track("pricing_viewed");

    btn.onclick = async () => {
      msg.textContent = "";
      btn.disabled = true;

      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) {
        window.location.href = "/login/";
        return;
      }

      // ✅ Tracking: Checkout Klick
      track("checkout_clicked");

      const res = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: { Authorization: `Bearer ${session.access_token}` }
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data?.url) {
        msg.textContent = data?.error ? `Fehler: ${data.error}` : "Fehler beim Starten des Checkouts.";
        btn.disabled = false;
        track("checkout_start_failed", { http_status: res.status, error: data?.error || null });
        return;
      }

      // ✅ Tracking: Checkout Session erstellt
      track("checkout_session_created");

      window.location.href = data.url;
    };
  </script>
</body>
</html>
